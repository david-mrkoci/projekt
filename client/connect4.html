<!-- 
znači:
klijent šalje ime i dobiva id(isti kao poslano ime zasad),
 mojred(true/false) i uspjeh(true.
 Tada započinje igru (crta ploču).
 Kada klikne na canvas, izračuna se koji je to stupac i na koju visinu se mora ubaciti.
Gleda je li pobijedio i onda šalje id, kraj(true/false), row, col serveru i čeka
na odgovor koji znači potez drugog igrača. Dobiva od servera kraj, row i col.
 -->

 <!--
     Napisana funkcija show_timer()
     Svaki put kad se mijenja poruka u "Vi ste na potezu"
     pokazuje se timer i pocinje odbrojavati od 120
 -->

 <!-- 
     problemi:
     -na serveru se nagomilavaju datoteke ako neki igrač izađe iz igre, to se može srediti timerom na serveru
     -server treba na neki način slati igraču ako je drugi igrač izašao iz igre ili nije napravio potez u roku
  -->

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf8">
    <title>Connect four</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
</head>
<body>
    <h1>Connect four</h1>

    <br>
    <div id="divime">
        Korisničko ime: <input type="text" id="ime"><br>
    </div>
        <input type="button" id="start" value = "Start"><br>


    <h3 id="poruka"></h3>
    <div id="divinfo">
        <label id="labelvrijeme">Preostalo vrijeme za potez: </label>
        <label id="timer"></label>
    </div>

    <script>
    var id = false; 
    var mojred;
    var blockwidth = 100;
    var blockheight = 100;
    var nRows=7, nCols=7;
    var id="nema";
    var jaboja, protivnikboja;
    var cnv;
    var ctx;
    var ploca;
    var kraj = false;
    var ime = undefined;
    var timer;//mora bit globalan da se moze stopirat

$( window ).on("load", function()
{
    $("#divinfo").hide();
    //klikom na gumb start serveru se šalje ime 
    $( "#start" ).on( "click", function(e)
    {
        if (timer !== undefined) stop_timer();
        $("#cnv").remove();
        $("#divinfo").hide();
        if (ime === undefined) //ovo je istina samo za prvu igru na stranici
        {
            if (! (/^[a-zA-Z0-9]{2,30}$/.test($("#ime").val()) ))
            {
                alert("Korisničko ime se mora sastojati od slova i znamenki");
                return;
            }
            ime = $("#ime").val();
            console.log(ime);
            $("#divime").hide();
            $("#start").val("Nova igra");
        }
        $("#poruka").html("Tražim drugog igrača...");
        $.ajax(
        {
            type: 'GET',
            url: "../server/username.php",
            data:
            {
                ime: ime
            },
            success: function( data )
            {//prima boja id, mojred
                console.log(data);
                id = data.id;
                mojred = data.mojred;

                if (mojred)
                {
                    $("#poruka").html("Vi ste na potezu.");
                }
                else
                {
                    $("#poruka").html("Protivnik je na potezu");
                }

                //jaboja = data.boja;
                //protivnikboja = (jaboja === "red" ? "yellow" : "red");
                jaboja = "red"; protivnikboja = "yellow";
                igra();

                $("#divinfo").show();
            },
            error: function( xhr, status )
            {
                if( status !== null )
                    console.log( "Greška prilikom Ajax poziva: " + status );
            }
        } );
        
    } );

    function igra()
    {
        nacrtajPlocu();
        ploca = [];
        for(var i=0; i<nRows; ++i) {
           ploca[i] = new Array(nCols);
           //ploca je dimenzija nRows x nCols 
           //undefined na svakom mjestu
        }    
        show_timer();
        if (!mojred)//ako nije moj red, moram cekat potez suigrača, šaljem dummy potez
        {
            $.ajax(//čekam potez drugog igrača
            {
                type: 'GET',
                url: "../server/move.php", //mozda druga skripta
                data:
                {
                    id: id,
                    row: -1,
                    col: -1,
                    kraj: false
                },
                success: function( data )//u data je potez drugog igrača
                {
                    stop_timer();
                    console.log(data);
                    if (data.hasOwnProperty("istekloVrijeme") && data.istekloVrijeme)
                    {
                        console.log("pobjeda - protivnik napustio igru");
                        alert("POBJEDILI STE! Protivnik je napustio igru");
                        $("#poruka").html("POBJEDILI STE! Protivnik je napustio igru");
                    }
                    else 
                    {
                        ubaci(Number(data.row), Number(data.col), protivnikboja);
                        mojred=true; //omoguci potez
                        $("#poruka").html("Vi ste na potezu.");
                        show_timer();
                    }
                },
                error: function( xhr, status )//mozda treba timeout obraditi
                {
                    if( status !== null )
                        console.log( "Greška prilikom Ajax poziva: " + status );
                }
            } );
        }               
    }

    function canvasclick(e) //lijevi klik
    {
        if(!mojred)//nije moj red => ništa se ne događa
            return;
        var rect = $("#cnv").get(0).getBoundingClientRect();
        var x = e.clientX - rect.left,//lokacija klika je (x,y)
            y = e.clientY - rect.top;
        col= Math.floor(x/blockwidth);// stupac na koji je kliknuto
        row= topRow(col);//nađi redak na koji mora ići ide žeton
        if (row < 0)//nema mjesta u tom stupcu
            return;
        console.log("ubacujem na polje: ", row, col);
        if (timer !== undefined) stop_timer();
        ubaci(row, col, jaboja);//treci arg je igrac=boja
        var kraj = gotovo(row, col);//je li gotovo
        if (kraj)
        {
            console.log("pobjeda");
            alert("POBJEDILI STE!");
            $("#poruka").html("POBJEDILI STE!");
        }
        else
        {
            $("#poruka").html("Protivnik je na potezu");
            show_timer();
        }
        mojred = false;
        $.ajax(//šaljem svoj potez i čekam potez drugog igrača
        {
            type: 'GET',
            url: "../server/move.php", //mozda druga skripta
            data:
            {
                id: id,
                row: row,
                col: col,
                kraj: kraj
            },
            success: function( data )//u data je potez drugog igrača
            {
                console.log(data);
                stop_timer();
                if (!kraj) //prima potez samo ako nije pobijedio, inače prima nešto random
                {
                    if (data.hasOwnProperty("istekloVrijeme") && data.istekloVrijeme)
                    {
                        console.log("pobjeda - protivnik napustio igru");
                        alert("POBJEDILI STE! Protivnik je napustio igru");
                        $("#poruka").html("POBJEDILI STE! Protivnik je napustio igru");
                    }
                    else 
                    {
                        ubaci(Number(data.row), Number(data.col), protivnikboja);
                        if (data.kraj) 
                        {
                                console.log("poraz");
                                alert("IZGUBILI STE!");
                                $("#poruka").html("IZGUBILI STE!");
                        }
                        else 
                        {
                            mojred=true; //omoguci potez
                            $("#poruka").html("Vi ste na potezu.");
                            show_timer();
                        }
                    }
                }
            },
            error: function( xhr, status )//mozda treba timeout obraditi
            {
                if( status !== null )
                    console.log( "Greška prilikom Ajax poziva: " + status );
            }
        } );
    };
    function jeLiStupacPun(col)
    {
        return ploca[0][col] !== undefined;
    }
    function topRow(col)//vraca -1 ako nema mjesta više
    {
        var corrow = nRows-1;
        while (corrow>=0 && ploca[corrow][col] !== undefined) corrow--;
        return corrow;
    }
    function gotovo(row, col)
    {
        //funkcija vraca true ako se postigao pogodak
        //ubacivanjem na mjesto row, col
        //pogodak se dogodio ako je u nekom od sljedeca 4 smjera
        //broj istovrsnih zetona oko mjesta (row, col) visekratnik
        //broja 4
        var smjerovi = [
            [ [-1,0], [1,0] ],//gore,dolje
            [ [0, -1], [0,1] ],//lijevo,desno
            [ [-1,-1], [1,1] ],//gorelijevo,doljedesno
            [ [1,-1], [-1,1] ],//doljelijevo,goredesno
        ];
        var igrac = ploca[row][col];
        var bodovi = 0;
        smjerovi.forEach(function(smjer)
        {
            smjerrow = smjer[0][0];
            smjercol = smjer[0][1];
            i = 1;
            while(//idem koliko mogu u prvom smjeru
                row + i * smjerrow >= 0 && row + i * smjerrow <nRows &&
                col + i * smjercol >= 0 && col + i * smjercol <nCols &&
                ploca[ row + i * smjerrow ][ col + i * smjercol ] === igrac
                ) 
                ++i;
            smjerrow = smjer[1][0];
            smjercol = smjer[1][1];
            j = 1;
            while(//idem koliko mogu u drugom smjeru
                col + j * smjercol >= 0 && col + j * smjercol <nCols &&
                row + j * smjerrow >= 0 && row + j * smjerrow <nRows &&
                ploca[ row + j * smjerrow ][ col + j * smjercol ] === igrac
                ) 
                ++j;
            //console.log("i+j-1 = ", i+j-1);
            //i,j >1 0
            i = (i - 1) % 4;//-1 jer se mjesto (row, col) broji
            j = (j - 1) % 4;//-1 jer se mjesto (row, col) broji

            var brUzastopnih = (i+j + 1);
            if( brUzastopnih >= 4)
                ++bodovi;
        });
        console.log("bodovi : ", bodovi);
        return bodovi != 0;
    }
    //ubacuje igraca na plocu na polje (row, col)
    //igrac mora biti boja!!
    function ubaci(row, col, boja)//lijevi klik
    {
        ploca[row][col] = boja;
        //console.log(ploca);
        nacrtajKrug(row, col, boja);
    }
    function nacrtajKrug(row, col, color)
    {
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.arc(
            col*blockwidth + blockwidth/2,
            row*blockheight + blockheight/2, 
            blockwidth/2 - 5,
            0,
            2*Math.PI
            );
        ctx.fill();
        ctx.stroke();
    }

    function nacrtajPlocu()//crta praznu plocu
    {
        $('#cnv').remove();
        var canvasheight = nRows*blockheight;
        var canvaswidth = nCols*blockwidth;
        $("body").append(
            $("<canvas>")
                .attr('id', 'cnv')
                .attr('width', canvaswidth + "px")
                .attr('height', canvasheight + "px")
                .css('border' , "1px solid #000000")
                .on("contextmenu", function() { return false; })
                .on('mousedown', canvasclick )
        );

        ctx = $('#cnv').get(0).getContext( "2d" );
        ctx.fillStyle = '#9F9F9F';
        ctx.fillRect(0, 0, canvaswidth, canvasheight);

        ctx.beginPath();
        for(var i=0; i<=nCols; ++i)//crta vertikalne crte
        {
            ctx.moveTo(i*blockwidth, 0);
            ctx.lineTo(i*blockwidth, canvasheight);
            ctx.stroke();
        }
        for(var i=0; i<=nRows; ++i)//crta horizontalne crte
        {
            ctx.moveTo(0, i*blockheight);
            ctx.lineTo(canvaswidth, i*blockheight);
        }
        ctx.stroke();
    }

    function show_timer()
    {
        // vrijeme do kojeg odbrojavamo (imamo 2 minute za potez)
        var countDownTime = new Date().getTime() + 120000;

        // updejtamo timer svaku sekundu
        timer = setInterval(function()
        {
            // dohvatimo trenutno vrijeme
            var now = new Date().getTime();

            // izracunamo razliku
            var time_left = countDownTime - now;

            // prikazemo vrijeme u elementu s id-om "timer"
            $("#timer").html(Math.floor(time_left /1000));
            //console.log(Math.floor(time_left /1000));

            // ako je odbrojavanje gotovo ne prikazujemo nista
            if (time_left < 0) {
                clearInterval(timer);
                $("#timer").html("0");
                if (mojred)
                    $("#poruka").html("IZGUBILI STE! Vrijeme za vaš potez je isteklo.");
                //else
                //    $("#poruka").html("POBIJEDILI STE! Vrijeme za potez protivnika je isteklo.");
                mojred = false;//onemogući potez
            }
        }, 1000);
    }
    function stop_timer()
    {
        clearInterval(timer);
    }

} );

    </script>
</body>
</html>
